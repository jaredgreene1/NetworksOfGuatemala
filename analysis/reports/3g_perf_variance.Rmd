---
title: "3G Performance Variance Overview"
author: Jared
---



```{r include= F}
  # Set up the doc environment 

  library(knitr)
  library(ggplot2)
  library(EnvStats)
  library(dplyr)

  qosDataPath <- "~/Guatemala/NetworksOfGuatemala/data/tigo/perfMaySept.RData"
  navDataPath <- "~/Guatemala/NetworksOfGuatemala/data/tigo/PrensaNavData.RData"
  cellDataPath <- "~/Guatemala/NetworksOfGuatemala/data/tigo/cells.csv"    

  color1 <- "#941010"

```

## Data Overview
We'll start by taking a look at a few dummy rows for the dataset to better understand what we're working with.  

**Note:** This is fake data but the data and categories are representative of the dataset used.


##Cell performance
```{r message= F, echo= F}

  monthYear <- c("08-2018", "10-2018", "09-2018")
  cellId <- c("HJAK7842","LAQ32J", "ABC123") 
  classif <- c("PREPAID", "POSTPAID", "PREPAID")
  deviceTech <- c("LTE", "NO-SMART", "SMART")
  subsPerDay <- c(10, 5, 3)
  mbs  <- c(13.1234, 3.1234, 1.1234)
  mbs2G <- c(0, 0, 1.1234)
  mbs3G <- c(13.1234, 0, 0)
  mbs4G <- c(0, 3.1234, 0)
  time2G <- c(0, 0, 1921) 
  time3G <- c(2152, 0, 0) 
  time4G <- c(0, 1050, 0) 
  timeNavReq3G <- c(1920, 0, 0)
  timeNavReq4G <- c(0, 832, 0)
  
  dataSample <- data.frame(monthYear, cellId, classif, deviceTech, subsPerDay, mbs, mbs2G, mbs3G, mbs4G, time2G, time3G, time4G, timeNavReq3G, timeNavReq4G) 

  kable(dataSample)
```

## Variation: 3G Performance data
Now we'll look at how quality of service (QOS) ratios vary.
QOS is calculated as `time / timeNavReq`

```{r message= F}
  # add performance ratio numbers
  qos <- readRDS(qosDataPath)
  qos$perfRatio3g <- qos$timenavreq3g/qos$time3g


  globalMean3g <- mean(qos$perfRatio3g, na.rm=T)
  print(globalMean3g)

  # calculate avg performance ratios over time per cell 
  cellAvg <- group_by(qos, lvl_val) %>%
  summarise(
      avgPerf3g = mean(perfRatio3g),
      varPerf3g = var(perfRatio3g))

  # merge cell performance averages with the rest of the dataset and
  # calculate deviation from cell performance mean
  qos <- left_join(qos, cellAvg) %>%
    mutate(
      cellPerfDiff3g   = perfRatio3g - avgPerf3g,
      globalPerfDiff3g = perfRatio3g - globalMean3g
    )

  # remove non-3g transceiver cells
  qos3g <- qos[qos$mbytes3g > 0,]

  # remove NAs and NaNs
  qos3g <- qos3g[!qos3g$cellPerfDiff3g %in% c(NaN, NA),]
``` 
```{r message= F, echo= F}
  ggplot(qos3g, aes(x=avgPerf3g)) + 
    geom_histogram(color= color1, fill= color1, binwidth=.005) + 
    labs(title="Distribution of mean cell performance", 
      x= "mean cell performance ratio")
  
  ggplot(qos3g, aes(x=cellPerfDiff3g)) + 
    geom_histogram(color= color1, fill= color1, binwidth= .005) + 
    labs(title="Distribution of deviations from cell performance mean", 
      x= "deviation from cell mean performance")

  ggplot(qos3g, aes(x=globalPerfDiff3g)) + 
    geom_histogram(color= color1, fill= color1, binwidth=.005) + 
    labs(title="Distribution of deviations from global performance mean", 
      x= "deviation from global mean performance")
```
```

```{r include= F}
```
##### Cell performance mean
```{r}
  summary(qos3g$avgPerf3g)
```
##### Cell performance deviation from the mean
```{r}
  summary(qos3g$cellPerfDiff3g)
```
##### Cell performance variance testing
```{r}
  var(qos3g$avgPerf3g)
```
##### Cell performance deviation variance testing
```{r}
  var(qos3g$cellPerfDiff3g)
```
##### Global performance variance testing
```{r}
  var(qos3g$perfRatio3g)
```
##### Mean performance vs cell variance
```{r echo=F, message=F}
  #plot performance mean and average cell variance
  ggplot(qos3g, aes(x = varPerf3g, y = avgPerf3g)) +
    geom_point(color= color1) + 
    labs(x = "cell performance variance", y = "mean cell performance")

```

##### Drilling down on variance, splitting between high and low var `threshold = .05`
```{r}
  qos3g.highvar <- qos3g[qos3g$varPerf3g > .05,]
  qos3g.lowvar <- qos3g[qos3g$varPerf3g < .05,]
```
`r length(unique(qos3g.highvar$lvl_val)) ` cells have a variance greater than .05  

`r length(unique((qos3g.lowvar)$lvl_val)) ` cells have a variance less than .05

```{r}
  ggplot(qos3g.highvar, aes(x = varPerf3g, y = avgPerf3g)) +
    geom_point(color= color1) + 
    labs(x = "cell performance variance", y = "mean cell performance", title="High Variance")
  
  ggplot(qos3g.lowvar, aes(x = varPerf3g, y = avgPerf3g)) +
    geom_point(color= color1) + 
    labs(x = "cell performance variance", y = "mean cell performance", title="Low Variance")
  

```





